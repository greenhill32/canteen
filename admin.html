<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canteen Honesty Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-6xl mx-auto mt-8 p-6 bg-white rounded-lg shadow-md">
    <!-- Header with Logo -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center space-x-4">
        <img src="logo.png" alt="Canteen Logo" class="h-32 w-auto" onerror="this.style.display='none'">
        <h1 class="text-3xl font-bold">Canteen Honesty Admin</h1>
      </div>
    </div>

    <!-- Advanced Controls -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <!-- Left Controls -->
      <div class="space-y-4">
        <!-- Search Box -->
        <div>
          <label for="searchBox" class="block text-sm font-medium text-gray-700 mb-1">Search by name:</label>
          <input type="text" id="searchBox" placeholder="Type to search names..." 
                 class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        
        <!-- Status Filter -->
        <div class="flex items-center space-x-4">
          <div>
            <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-1">View:</label>
            <select id="statusFilter" class="p-2 border border-gray-300 rounded-md">
              <option value="outstanding">Outstanding</option>
              <option value="archive">Archive (Paid + Deleted)</option>
              <option value="all">All Records</option>
            </select>
          </div>
          <div>
            <button id="reloadBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
              🔄 Reload
            </button>
          </div>
        </div>
      </div>

      <!-- Right Controls -->
      <div class="space-y-4">
        <!-- Date Range Filter -->
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label for="dateFrom" class="block text-sm font-medium text-gray-700 mb-1">From:</label>
            <input type="date" id="dateFrom" class="w-full p-2 border border-gray-300 rounded-md">
          </div>
          <div>
            <label for="dateTo" class="block text-sm font-medium text-gray-700 mb-1">To:</label>
            <input type="date" id="dateTo" class="w-full p-2 border border-gray-300 rounded-md">
          </div>
        </div>
        
        <!-- Export Controls -->
        <div class="flex flex-wrap gap-2">
          <a id="exportBtn" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 transition-colors text-sm" href="#">
            📊 Export CSV
          </a>
          <button id="pdfWeeklyBtn" class="bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 transition-colors text-sm">
            📄 Weekly PDF
          </button>
          <button id="pdfMonthlyBtn" class="bg-indigo-600 text-white px-3 py-2 rounded-md hover:bg-indigo-700 transition-colors text-sm">
            📅 Monthly PDF
          </button>
        </div>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div id="bulkActions" class="mb-4 p-3 bg-gray-50 rounded-md hidden">
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm font-medium">Bulk Actions:</span>
        <button id="bulkMarkPaid" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
          ✅ Mark Paid
        </button>
        <button id="bulkDelete" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
          🗑️ Delete
        </button>
        <button id="bulkRestore" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
          🔁 Restore
        </button>
        <button id="clearSelection" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
          Clear Selection
        </button>
        <span id="selectedCount" class="text-sm text-gray-600 ml-2"></span>
      </div>
    </div>

    <!-- Summary -->
    <div id="summary" class="mb-4 p-3 bg-blue-50 rounded-md border border-blue-200"></div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm" id="recordsTable">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="px-2 py-2">
              <input type="checkbox" id="selectAll" class="form-checkbox h-4 w-4">
            </th>
            <th class="px-2 py-2 cursor-pointer hover:bg-gray-300" data-sort="timestamp">
              Time ↕️
            </th>
            <th class="px-2 py-2 cursor-pointer hover:bg-gray-300" data-sort="name">
              Name ↕️
            </th>
            <th class="px-2 py-2">Items</th>
            <th class="px-2 py-2 text-center">Count</th>
            <th class="px-2 py-2 cursor-pointer hover:bg-gray-300" data-sort="status">
              Status ↕️
            </th>
            <th class="px-2 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    
    <!-- Loading and Messages -->
    <div id="loadingSpinner" class="text-center py-8 hidden">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <p class="mt-2 text-gray-600">Loading...</p>
    </div>
    <div id="adminMessage" class="mt-4 text-center text-sm"></div>
  </div>

  <script>
    // Configure your API endpoint here
    const API_URL = 'https://script.google.com/macros/s/AKfycbzlgPZ3ZsUW47s5jEticqAw75X09JdqVz45uzvd07WQJom4ZxbQSHc7nXMS3AYfHWTsrg/exec';
    
    // DOM Elements
    const statusFilter = document.getElementById('statusFilter');
    const searchBox = document.getElementById('searchBox');
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');
    const reloadBtn = document.getElementById('reloadBtn');
    const exportBtn = document.getElementById('exportBtn');
    const pdfWeeklyBtn = document.getElementById('pdfWeeklyBtn');
    const pdfMonthlyBtn = document.getElementById('pdfMonthlyBtn');
    const tableBody = document.getElementById('tableBody');
    const summary = document.getElementById('summary');
    const adminMessage = document.getElementById('adminMessage');
    const selectAll = document.getElementById('selectAll');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // Global data storage
    let allRecords = [];
    let filteredRecords = [];
    let sortField = 'timestamp';
    let sortDirection = 'desc';

    // Initialize date filters to current week
    function initializeDateFilters() {
      const today = new Date();
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      dateFrom.value = weekAgo.toISOString().split('T')[0];
      dateTo.value = today.toISOString().split('T')[0];
    }

    async function loadRecords() {
      showLoading(true);
      const mode = statusFilter.value;
      const statusParam = mode === 'archive' ? 'archive' : mode;
      const params = new URLSearchParams();
      params.append('action', 'list');
      params.append('status', statusParam);
      params.append('limit', '500');
      
      try {
        const res = await fetch(`${API_URL}?${params.toString()}`, { method: 'GET' });
        const data = await res.json();
        
        if (!data.ok) {
          showMessage(data.message || 'Failed to fetch records.', 'error');
          return;
        }
        
        allRecords = data.data.items || [];
        applyFiltersAndSort();
        showMessage('', '');
        
      } catch (err) {
        showMessage('Network error while loading records.', 'error');
      } finally {
        showLoading(false);
      }
      
      updateExportLink();
    }

    function applyFiltersAndSort() {
      let filtered = [...allRecords];
      
      // Apply search filter
      const searchTerm = searchBox.value.toLowerCase().trim();
      if (searchTerm) {
        filtered = filtered.filter(rec => 
          rec.name.toLowerCase().includes(searchTerm) ||
          rec.items.toLowerCase().includes(searchTerm)
        );
      }
      
      // Apply date filter
      const fromDate = dateFrom.value;
      const toDate = dateTo.value;
      if (fromDate || toDate) {
        filtered = filtered.filter(rec => {
          const recDate = new Date(rec.timestamp).toISOString().split('T')[0];
          const afterFrom = !fromDate || recDate >= fromDate;
          const beforeTo = !toDate || recDate <= toDate;
          return afterFrom && beforeTo;
        });
      }
      
      // Apply sorting
      filtered.sort((a, b) => {
        let aVal = a[sortField];
        let bVal = b[sortField];
        
        if (sortField === 'timestamp') {
          aVal = new Date(aVal).getTime();
          bVal = new Date(bVal).getTime();
        } else if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }
        
        const comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        return sortDirection === 'asc' ? comparison : -comparison;
      });
      
      filteredRecords = filtered;
      populateTable();
      updateSummary();
    }

    function populateTable() {
      tableBody.innerHTML = '';
      
      filteredRecords.forEach(rec => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        tr.dataset.id = rec.id;
        
        const statusClass = {
          'outstanding': 'text-orange-600 bg-orange-100',
          'paid': 'text-green-600 bg-green-100',
          'deleted': 'text-red-600 bg-red-100'
        }[rec.status] || 'text-gray-600';
        
        tr.innerHTML = `
          <td class="px-2 py-2">
            <input type="checkbox" class="record-checkbox form-checkbox h-4 w-4" data-id="${rec.id}">
          </td>
          <td class="px-2 py-2 whitespace-nowrap text-xs">
            ${escapeHtml(new Date(rec.timestamp).toLocaleString())}
          </td>
          <td class="px-2 py-2 font-medium">${escapeHtml(rec.name)}</td>
          <td class="px-2 py-2">${escapeHtml(rec.items)}</td>
          <td class="px-2 py-2 text-center font-semibold">${rec.item_count}</td>
          <td class="px-2 py-2">
            <span class="px-2 py-1 rounded-full text-xs ${statusClass}">
              ${escapeHtml(rec.status)}
            </span>
          </td>
          <td class="px-2 py-2">
            ${getActionButtons(rec)}
          </td>
        `;
        tableBody.appendChild(tr);
      });
      
      updateBulkActions();
    }

    function getActionButtons(rec) {
      if (rec.status === 'outstanding') {
        return `
          <button class="text-green-600 hover:bg-green-50 px-2 py-1 rounded text-xs mr-1" 
                  data-action="markPaid" data-id="${rec.id}">✅ Paid</button>
          <button class="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-xs" 
                  data-action="delete" data-id="${rec.id}">🗑️ Delete</button>
        `;
      } else if (rec.status === 'deleted') {
        return `
          <button class="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-xs" 
                  data-action="restore" data-id="${rec.id}">🔁 Restore</button>
        `;
      } else {
        return '<span class="text-gray-400 text-xs">—</span>';
      }
    }

    function updateSummary() {
      const total = filteredRecords.length;
      const outstanding = filteredRecords.filter(r => r.status === 'outstanding').length;
      const paid = filteredRecords.filter(r => r.status === 'paid').length;
      const deleted = filteredRecords.filter(r => r.status === 'deleted').length;
      const totalItems = filteredRecords.reduce((sum, r) => sum + (r.item_count || 0), 0);
      
      summary.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
          <div><span class="font-semibold text-blue-600">${total}</span><br><span class="text-xs">Total Records</span></div>
          <div><span class="font-semibold text-orange-600">${outstanding}</span><br><span class="text-xs">Outstanding</span></div>
          <div><span class="font-semibold text-green-600">${paid}</span><br><span class="text-xs">Paid</span></div>
          <div><span class="font-semibold text-red-600">${deleted}</span><br><span class="text-xs">Deleted</span></div>
          <div><span class="font-semibold text-purple-600">${totalItems}</span><br><span class="text-xs">Total Items</span></div>
        </div>
      `;
    }

    function updateBulkActions() {
      const checkboxes = document.querySelectorAll('.record-checkbox');
      const selectedCheckboxes = document.querySelectorAll('.record-checkbox:checked');
      
      if (selectedCheckboxes.length > 0) {
        bulkActions.classList.remove('hidden');
        selectedCount.textContent = `${selectedCheckboxes.length} selected`;
      } else {
        bulkActions.classList.add('hidden');
      }
      
      // Update select all checkbox
      selectAll.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < checkboxes.length;
      selectAll.checked = checkboxes.length > 0 && selectedCheckboxes.length === checkboxes.length;
    }

    function updateExportLink() {
      const mode = statusFilter.value;
      const statusParam = mode === 'archive' ? 'archive' : mode;
      exportBtn.href = `${API_URL}?action=export&status=${encodeURIComponent(statusParam)}`;
    }

    function showLoading(show) {
      if (show) {
        loadingSpinner.classList.remove('hidden');
        tableBody.style.opacity = '0.5';
      } else {
        loadingSpinner.classList.add('hidden');
        tableBody.style.opacity = '1';
      }
    }

    function showMessage(text, type = 'info') {
      if (!text) {
        adminMessage.textContent = '';
        adminMessage.className = 'mt-4 text-center text-sm';
        return;
      }
      
      adminMessage.textContent = text;
      adminMessage.className = 'mt-4 text-center text-sm p-2 rounded ';
      
      if (type === 'error') {
        adminMessage.className += 'bg-red-50 text-red-600 border border-red-200';
      } else if (type === 'success') {
        adminMessage.className += 'bg-green-50 text-green-600 border border-green-200';
      } else {
        adminMessage.className += 'bg-blue-50 text-blue-600 border border-blue-200';
      }
      
      if (type === 'success') {
        setTimeout(() => showMessage('', ''), 3000);
      }
    }

    // Utility function
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        "'": '&#39;',
        '"': '&quot;',
      };
      return String(text).replace(/[&<>\'\"]/g, (m) => map[m]);
    }

    // PDF Generation Functions
    function generatePDF(period) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Calculate date range
      const now = new Date();
      let startDate, endDate;
      
      if (period === 'weekly') {
        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        endDate = now;
      } else {
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      }
      
      // Filter records for the period
      const periodRecords = allRecords.filter(rec => {
        const recDate = new Date(rec.timestamp);
        return recDate >= startDate && recDate <= endDate;
      });
      
      // PDF Header
      doc.setFontSize(20);
      doc.text('Canteen Honesty System Report', 20, 20);
      doc.setFontSize(12);
      doc.text(`${period.charAt(0).toUpperCase() + period.slice(1)} Report`, 20, 30);
      doc.text(`Period: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`, 20, 40);
      
      // Summary stats
      const outstanding = periodRecords.filter(r => r.status === 'outstanding').length;
      const paid = periodRecords.filter(r => r.status === 'paid').length;
      const deleted = periodRecords.filter(r => r.status === 'deleted').length;
      const totalItems = periodRecords.reduce((sum, r) => sum + (r.item_count || 0), 0);
      
      doc.text(`Total Records: ${periodRecords.length}`, 20, 55);
      doc.text(`Outstanding: ${outstanding}`, 20, 65);
      doc.text(`Paid: ${paid}`, 90, 65);
      doc.text(`Deleted: ${deleted}`, 140, 65);
      doc.text(`Total Items: ${totalItems}`, 20, 75);
      
      // Table header
      let yPos = 90;
      doc.setFontSize(10);
      doc.text('Date', 20, yPos);
      doc.text('Name', 50, yPos);
      doc.text('Items', 100, yPos);
      doc.text('Count', 150, yPos);
      doc.text('Status', 170, yPos);
      
      yPos += 10;
      
      // Table data
      periodRecords.slice(0, 40).forEach(rec => { // Limit to first 40 records
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        doc.text(new Date(rec.timestamp).toLocaleDateString(), 20, yPos);
        doc.text(rec.name.substring(0, 15), 50, yPos);
        doc.text(rec.items.substring(0, 20), 100, yPos);
        doc.text(rec.item_count.toString(), 150, yPos);
        doc.text(rec.status, 170, yPos);
        yPos += 8;
      });
      
      // Save PDF
      const filename = `canteen-${period}-report-${now.toISOString().split('T')[0]}.pdf`;
      doc.save(filename);
    }

    // Event Listeners
    statusFilter.addEventListener('change', applyFiltersAndSort);
    searchBox.addEventListener('input', applyFiltersAndSort);
    dateFrom.addEventListener('change', applyFiltersAndSort);
    dateTo.addEventListener('change', applyFiltersAndSort);
    reloadBtn.addEventListener('click', loadRecords);

    // Sorting
    document.querySelectorAll('[data-sort]').forEach(header => {
      header.addEventListener('click', () => {
        const field = header.dataset.sort;
        if (sortField === field) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortField = field;
          sortDirection = 'asc';
        }
        applyFiltersAndSort();
      });
    });

    // Select All checkbox
    selectAll.addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.record-checkbox');
      checkboxes.forEach(cb => cb.checked = this.checked);
      updateBulkActions();
    });

    // Individual checkboxes
    tableBody.addEventListener('change', function(e) {
      if (e.target.classList.contains('record-checkbox')) {
        updateBulkActions();
      }
    });

    // Individual row actions
    tableBody.addEventListener('click', async (evt) => {
      const target = evt.target;
      if (!target.dataset || !target.dataset.action) return;
      
      const id = target.dataset.id;
      const action = target.dataset.action;
      
      await performAction(action, [id]);
    });

    // Bulk actions
    document.getElementById('bulkMarkPaid').addEventListener('click', async () => {
      const selectedIds = getSelectedIds();
      if (selectedIds.length === 0) return;
      
      if (confirm(`Mark ${selectedIds.length} records as paid?`)) {
        await performAction('markPaid', selectedIds);
      }
    });

    document.getElementById('bulkDelete').addEventListener('click', async () => {
      const selectedIds = getSelectedIds();
      if (selectedIds.length === 0) return;
      
      if (confirm(`Delete ${selectedIds.length} records?`)) {
        await performAction('delete', selectedIds);
      }
    });

    document.getElementById('bulkRestore').addEventListener('click', async () => {
      const selectedIds = getSelectedIds();
      if (selectedIds.length === 0) return;
      
      if (confirm(`Restore ${selectedIds.length} records?`)) {
        await performAction('restore', selectedIds);
      }
    });

    document.getElementById('clearSelection').addEventListener('click', () => {
      document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = false);
      selectAll.checked = false;
      updateBulkActions();
    });

    // PDF generation
    pdfWeeklyBtn.addEventListener('click', () => generatePDF('weekly'));
    pdfMonthlyBtn.addEventListener('click', () => generatePDF('monthly'));

    function getSelectedIds() {
      return Array.from(document.querySelectorAll('.record-checkbox:checked'))
        .map(cb => cb.dataset.id);
    }

    async function performAction(action, ids) {
      const actionMap = {
        'markPaid': 'paid',
        'delete': 'deleted',
        'restore': 'outstanding'
      };
      
      const newStatus = actionMap[action];
      if (!newStatus) return;
      
      showLoading(true);
      
      try {
        const promises = ids.map(id => {
          const params = new URLSearchParams();
          params.append('action', 'update');
          params.append('id', id);
          params.append('new_status', newStatus);
          params.append('status_by', 'Admin');
          
          return fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString(),
          });
        });
        
        const responses = await Promise.all(promises);
        const results = await Promise.all(responses.map(r => r.json()));
        
        const failures = results.filter(r => !r.ok);
        
        if (failures.length === 0) {
          showMessage(`Successfully updated ${ids.length} record(s)`, 'success');
          loadRecords();
          document.getElementById('clearSelection').click();
        } else {
          showMessage(`Updated ${ids.length - failures.length} records, ${failures.length} failed`, 'error');
          loadRecords();
        }
        
      } catch (err) {
        showMessage('Network error during bulk operation', 'error');
      } finally {
        showLoading(false);
      }
    }

    // Initialize
    initializeDateFilters();
    loadRecords();
  </script>
</body>
</html>