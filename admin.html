<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Canteen Honesty System</title>
  <style>
    *{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f5f5f5;margin:0;padding:24px}
    .container{max-width:1100px;margin:0 auto}
    .card{background:#fff;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.08);padding:24px;margin-bottom:20px}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{margin:0 0 6px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:12px}
    .stat{padding:18px;border-radius:12px;background:#fafafa;border:1px solid #eee;text-align:center}
    .stat b{display:block;font-size:28px;margin-bottom:4px}
    .row{overflow:auto}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:12px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
    th{position:sticky;top:0;background:#fafafa;font-weight:600}
    .badge{display:inline-block;background:#eef0f3;border:1px solid #e2e6ea;border-radius:999px;padding:2px 8px;margin:2px 6px 2px 0;font-size:.85em}
    .btn{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .b1{background:#222;color:#fff}.b2{background:#6c757d;color:#fff}.b3{background:#28a745;color:#fff}.b4{background:#dc3545;color:#fff}
    .input{padding:10px 12px;border:2px solid #e5e7eb;border-radius:10px}
    .auth{max-width:380px;margin:12vh auto}
    .msg{padding:12px;border-radius:10px;margin:10px 0}
    .ok{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .err{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .muted{color:#666}
  </style>
</head>
<body>
<div class="container">

  <!-- AUTH -->
  <div id="auth" class="card auth">
    <h2>Admin Access</h2>
    <p class="muted">Enter the admin password.</p>
    <input id="pw" type="password" class="input" placeholder="Admin password" style="width:100%;margin:10px 0 12px">
    <button class="btn b1" style="width:100%" onclick="auth()">Continue</button>
    <div id="authErr" class="msg err" style="display:none"></div>
  </div>

  <!-- DASH -->
  <div id="dash" style="display:none">
    <div class="card">
      <div class="flex" style="justify-content:space-between">
        <div>
          <h1>Admin Dashboard</h1>
          <div class="muted">Canteen Honesty System â€” Outstanding Items</div>
        </div>
        <div class="flex">
          <button class="btn b2" onclick="logout()">Logout</button>
        </div>
      </div>
      <div class="grid" style="margin-top:14px">
        <div class="stat"><b id="s_total">-</b>Total Entries</div>
        <div class="stat"><b id="s_items">-</b>Outstanding Items</div>
        <div class="stat"><b id="s_users">-</b>Unique Users</div>
        <div class="stat"><b id="s_today">-</b>Today's Entries</div>
      </div>
    </div>

    <div class="card">
      <div class="flex" style="justify-content:space-between;margin-bottom:10px">
        <h3 style="margin:0">Outstanding Items</h3>
        <div class="flex">
          <button id="btnRefresh" class="btn b2" onclick="refresh()">Refresh</button>
          <button id="btnExport" class="btn b1" onclick="exportSelected()" disabled>Export selected</button>
          <button id="btnPaid" class="btn b3" onclick="markPaid()" disabled>Mark paid</button>
          <button id="btnDelete" class="btn b4" onclick="deleteSelected()" disabled>Delete</button>
        </div>
      </div>

      <div class="flex" style="margin-bottom:10px">
        <input id="f_name" class="input" placeholder="Filter by name">
        <input id="f_date" class="input" type="date">
        <select id="f_item" class="input">
          <option value="">All items</option>
          <option value="sandwich">Sandwich</option>
          <option value="drink">Drink</option>
          <option value="chocolate">Chocolate Bar</option>
          <option value="pastry">Pastry</option>
        </select>
        <button class="btn b2" onclick="clearFilters()">Clear</button>
      </div>

      <div id="msg"></div>

      <div id="loading" class="muted">Loading data...</div>

      <div id="data" style="display:none">
        <label><input id="chkAll" type="checkbox" onclick="toggleAll()"> Select all visible</label>
        <div class="row">
          <table>
            <thead>
              <tr>
                <th style="width:60px">Select</th>
                <th>Date & Time</th>
                <th>Name</th>
                <th>Items</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ===== CONFIG =====
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzek8ORbrHqFPGz7VLPVHaVhr8HpwYZF-GIRb25BA2yY7fACwa-qk_NUHKpnpIb4cTh4w/exec";
const SECRET_KEY = "jhgghfaj;uryworu3qeghfrrfewfqf";
const ADMIN_PASSWORD = "admin123"; // client-side convenience only

// ===== STATE =====
let allData = [];
let filtered = [];
let selected = new Set();

// ===== AUTH =====
function auth(){
  const val = document.getElementById("pw").value;
  const err = document.getElementById("authErr");
  err.style.display = "none";
  if(val === ADMIN_PASSWORD){
    document.getElementById("auth").style.display = "none";
    document.getElementById("dash").style.display = "block";
    load();
  }else{
    err.textContent = "Invalid password. Try again.";
    err.style.display = "block";
  }
}
function logout(){
  document.getElementById("dash").style.display = "none";
  document.getElementById("auth").style.display = "block";
  document.getElementById("pw").value = "";
  document.getElementById("authErr").style.display = "none";
}

// ===== LOAD (JSONP) =====
async function load(){
  showLoading(true);
  try{
    await loadJSONP();
    processAndRender();
  }catch(e){
    showMsg("Failed to load data: " + e.message, true);
  }finally{
    showLoading(false);
  }
}

function loadJSONP(){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
    const cleanup = () => {
      delete window[cb];
      if(script.parentNode) script.parentNode.removeChild(script);
      clearTimeout(timer);
    };
    window[cb] = (payload)=>{
      try{
        if(!payload || !payload.success){ throw new Error(payload && payload.error ? payload.error : "Unknown error"); }
        let entries = payload.entries || [];
        // Normalize
        allData = entries.map((e, i)=>{
          const ts = e.timestamp ? new Date(e.timestamp) : new Date();
          return {
            id: e.id || (i+1),
            timestamp: ts.toISOString(),
            displayTimestamp: formatDT(ts),
            name: e.name || "",
            items: Array.isArray(e.items) ? e.items : (e.items ? String(e.items).split(",").map(s=>s.trim()) : []),
            itemCount: Number(e.itemCount || (Array.isArray(e.items) ? e.items.length : 0))
          };
        });
        resolve();
      }catch(err){ reject(err); }
      finally{ cleanup(); }
    };
    const script = document.createElement("script");
    const url = `${GOOGLE_SCRIPT_URL}?action=getData&secret=${encodeURIComponent(SECRET_KEY)}&callback=${cb}`;
    script.src = url;
    script.onerror = ()=>{ cleanup(); reject(new Error("JSONP load failed")); };
    document.body.appendChild(script);
    const timer = setTimeout(()=>{ cleanup(); reject(new Error("Request timeout")); }, 12000);
  });
}

// ===== RENDER =====
function processAndRender(){
  applyFilters(); // sets filtered
  updateStats();
  renderTable();
}
function updateStats(){
  const total = allData.length;
  const items = allData.reduce((a,c)=>a + (c.itemCount||0), 0);
  const users = new Set(allData.map(x=>x.name)).size;
  const today = new Date().toDateString();
  const todayCount = allData.filter(x=> new Date(x.timestamp).toDateString() === today ).length;
  byId("s_total").textContent = total;
  byId("s_items").textContent = items;
  byId("s_users").textContent = users;
  byId("s_today").textContent = todayCount;
}
function renderTable(){
  const tb = byId("tbody");
  if(filtered.length === 0){
    tb.innerHTML = `<tr><td colspan="6" class="muted" style="text-align:center;padding:28px">No entries found</td></tr>`;
  }else{
    tb.innerHTML = filtered.map(e=>`
      <tr>
        <td><input type="checkbox" data-id="${e.id}" onchange="toggleOne(${e.id}, this.checked)" ${selected.has(e.id)?'checked':''}></td>
        <td>${e.displayTimestamp}</td>
        <td><strong>${escapeHtml(e.name)}</strong></td>
        <td>${e.items.map(it=>`<span class="badge">${escapeHtml(it)}</span>`).join("")}</td>
        <td>${e.itemCount}</td>
        <td>
          <button class="btn b3" onclick="markOnePaid(${e.id})">Paid</button>
          <button class="btn b4" onclick="deleteOne(${e.id})">Delete</button>
        </td>
      </tr>
    `).join("");
  }
  updateActionButtons();
  byId("data").style.display = "block";
}

function updateActionButtons(){
  const hasAny = selected.size > 0;
  byId("btnExport").disabled = !hasAny;
  byId("btnPaid").disabled = !hasAny;
  byId("btnDelete").disabled = !hasAny;
}

// ===== FILTERS =====
function applyFilters(){
  const n = byId("f_name").value.trim().toLowerCase();
  const d = byId("f_date").value; // yyyy-mm-dd
  const it = byId("f_item").value;
  filtered = allData.filter(e=>{
    const okN = !n || e.name.toLowerCase().includes(n);
    const okD = !d || (e.timestamp || "").startsWith(d);
    const okI = !it || (Array.isArray(e.items) && e.items.includes(it));
    return okN && okD && okI;
  });
  // keep selected set only for visible rows
  selected = new Set([...selected].filter(id=> filtered.some(x=>x.id===id)));
}
function clearFilters(){
  byId("f_name").value = "";
  byId("f_date").value = "";
  byId("f_item").value = "";
  applyFilters();
  renderTable();
}

// ===== SELECTION =====
function toggleOne(id, on){
  if(on) selected.add(id); else selected.delete(id);
  updateActionButtons();
}
function toggleAll(){
  const on = byId("chkAll").checked;
  selected.clear();
  filtered.forEach(e=>{ if(on) selected.add(e.id); });
  renderTable();
}

// ===== ACTIONS =====
function refresh(){
  const b = byId("btnRefresh");
  b.disabled = true; b.textContent = "Refreshing...";
  load().finally(()=>{ b.disabled = false; b.textContent = "Refresh"; });
}
function exportSelected(){
  if(selected.size===0) return;
  const sel = allData.filter(e=> selected.has(e.id));
  const headers = ["Date & Time","Name","Items","Item Count"];
  const rows = sel.map(e=>[e.displayTimestamp, e.name, e.items.join("; "), e.itemCount]);
  const csv = [headers, ...rows].map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "canteen-selected.csv";
  a.click();
  URL.revokeObjectURL(a.href);
  showMsg(`Exported ${sel.length} entries.`, false);
}
async function markPaid(){
  if(selected.size===0) return;
  const sel = allData.filter(e=> selected.has(e.id));
  if(!confirm(`Mark ${sel.length} entr${sel.length>1?'ies':'y'} as PAID and remove?`)) return;
  await postToScript("markPaid", { entries: sel, paidAt: new Date().toISOString(), paidBy: "admin" });
  // remove locally
  allData = allData.filter(e=> !selected.has(e.id));
  selected.clear();
  processAndRender();
  showMsg("Marked as paid.", false);
}
async function markOnePaid(id){
  const e = allData.find(x=>x.id===id);
  if(!e) return;
  if(!confirm(`Mark ${e.name} (${e.items.join(", ")}) as PAID?`)) return;
  await postToScript("markPaid", { entries: [e], paidAt: new Date().toISOString(), paidBy: "admin" });
  allData = allData.filter(x=>x.id!==id);
  selected.delete(id);
  processAndRender();
  showMsg("Entry marked as paid.", false);
}
async function deleteSelected(){
  if(selected.size===0) return;
  if(!confirm(`Delete ${selected.size} selected entr${selected.size>1?'ies':'y'}? This cannot be undone.`)) return;
  const ids = [...selected];
  await postToScript("deleteEntries", { ids });
  allData = allData.filter(e=> !selected.has(e.id));
  selected.clear();
  processAndRender();
  showMsg("Deleted selected entries.", false);
}
async function deleteOne(id){
  if(!confirm("Delete this entry?")) return;
  await postToScript("deleteEntries", { ids:[id] });
  allData = allData.filter(e=> e.id!==id);
  selected.delete(id);
  processAndRender();
  showMsg("Entry deleted.", false);
}

// ===== APPS SCRIPT POST =====
async function postToScript(action, payload){
  // Note: no-cors -> opaque. We assume success server-side.
  try{
    await fetch(GOOGLE_SCRIPT_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      mode:"no-cors",
      body: JSON.stringify(Object.assign({ action, secret: SECRET_KEY }, payload||{}))
    });
  }catch(e){
    showMsg("Failed to contact server: " + e.message, true);
  }
}

// ===== UTILS =====
function byId(id){ return document.getElementById(id); }
function showLoading(on){
  byId("loading").style.display = on ? "block" : "none";
  byId("data").style.display = on ? "none" : "block";
}
function showMsg(text, isErr){
  const el = byId("msg");
  el.innerHTML = `<div class="msg ${isErr?'err':'ok'}">${escapeHtml(text)}</div>`;
  setTimeout(()=>{ el.innerHTML = ""; }, isErr ? 7000 : 5000);
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
}
function pad(n){ return n<10 ? "0"+n : ""+n; }
function formatDT(d){
  // dd/mm/yyyy, HH:MM:SS
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

// ===== EVENTS =====
byId("f_name").addEventListener("input", ()=>{ applyFilters(); renderTable(); });
byId("f_date").addEventListener("change", ()=>{ applyFilters(); renderTable(); });
byId("f_item").addEventListener("change", ()=>{ applyFilters(); renderTable(); });

console.log("Admin page loaded. JSONP reader active.");
</script>
</body>
</html>
